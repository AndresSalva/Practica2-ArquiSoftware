@page
@model GYMPT.Pages.DetailsUsers.DetailsUsersModel
@{
    ViewData["Title"] = "Detalles de Usuarios";
}

<h1>Detalles de Usuarios con Membresías</h1>

<!-- Mensajes -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["InfoMessage"] != null)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @TempData["InfoMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Botón para mostrar formulario -->
<button id="btnShowForm" class="btn btn-success mb-3" type="button">
    <i class="fas fa-plus"></i> Agregar Detalle de Usuario
</button>

<!-- Formulario oculto inicialmente -->
<div id="formContainer" class="card mb-4" style="display:none;">
    <div class="card-header">
        <h5 id="formTitle">Agregar Detalle de Usuario</h5>
    </div>
    <div class="card-body">
        <form method="post" id="detailUserForm" asp-antiforgery="true">
            <input type="hidden" asp-for="DetailUser.Id" />

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="DetailUser.IdUser" class="form-label">ID Usuario *</label>
                        <input asp-for="DetailUser.IdUser" class="form-control" required min="1" />
                        <small class="form-text text-muted">Ingrese el ID de un usuario existente y activo</small>
                        <span asp-validation-for="DetailUser.IdUser" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="DetailUser.IdMembership" class="form-label">ID Membresía *</label>
                        <input asp-for="DetailUser.IdMembership" class="form-control" required min="1" />
                        <small class="form-text text-muted">Ingrese el ID de una membresía existente y activa</small>
                        <span asp-validation-for="DetailUser.IdMembership" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="DetailUser.StartDate" class="form-label">Fecha Inicio *</label>
                        <input asp-for="DetailUser.StartDate" type="date" class="form-control" required />
                        <span asp-validation-for="DetailUser.StartDate" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="DetailUser.EndDate" class="form-label">Fecha Fin *</label>
                        <input asp-for="DetailUser.EndDate" type="date" class="form-control" required />
                        <span asp-validation-for="DetailUser.EndDate" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="DetailUser.SessionsLeft" class="form-label">Sesiones Restantes *</label>
                <input asp-for="DetailUser.SessionsLeft" class="form-control" required min="0" />
                <span asp-validation-for="DetailUser.SessionsLeft" class="text-danger"></span>
            </div>

            <div class="form-check mb-3">
                <input type="checkbox" asp-for="DetailUser.IsActive" class="form-check-input" />
                <label asp-for="DetailUser.IsActive" class="form-check-label">Activo</label>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" asp-page-handler="Create" id="createButton" class="btn btn-success">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <button type="submit" asp-page-handler="Update" id="updateButton" class="btn btn-primary" style="display:none;">
                    <i class="fas fa-edit"></i> Actualizar
                </button>
                <button type="button" class="btn btn-secondary" onclick="hideForm()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Tabla de detalles de usuario -->
@if (Model.DetailsUserList != null && Model.DetailsUserList.Any())
{
    <div class="card">
        <div class="card-header">
            <h5>Lista de Detalles de Usuarios</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>ID Usuario</th>
                            <th>ID Membresía</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Sesiones Restantes</th>
                            <th>Activo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var detail in Model.DetailsUserList)
                        {
                            <tr>
                                <td>@detail.Id</td>
                                <td>@detail.IdUser</td>
                                <td>@detail.IdMembership</td>
                                <td>@detail.StartDate.ToString("yyyy-MM-dd")</td>
                                <td>@detail.EndDate.ToString("yyyy-MM-dd")</td>
                                <td>
                                    <span class="badge bg-info">@detail.SessionsLeft</span>
                                </td>
                                <td>
                                    @if (detail.IsActive)
                                    {
                                        <span class="badge bg-success">Sí</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">No</span>
                                    }
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-primary"
                                                onclick="fillEditForm(
                                                            @detail.Id,
                                                            @detail.IdUser,
                                                            @detail.IdMembership,
                                                           '@detail.StartDate.ToString("yyyy-MM-dd")',
                                                           '@detail.EndDate.ToString("yyyy-MM-dd")',
                                                            @detail.SessionsLeft,
                                                            '@detail.IsActive'.toLowerCase())">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>

                                        <form method="post" asp-page-handler="Delete" asp-route-id="@detail.Id" style="display:inline">
                                            <button type="submit" class="btn btn-sm btn-danger"
                                                    onclick="return confirm('¿Está seguro de que desea eliminar este detalle de usuario?')">
                                                <i class="fas fa-trash"></i> Eliminar
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-info text-center">
        <i class="fas fa-info-circle"></i> No hay detalles de usuarios registrados.
    </div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Seguridad: obtener elementos con comprobación de existencia
        const formContainer = document.getElementById('formContainer');
        const btnShowForm = document.getElementById('btnShowForm');
        const createButton = document.getElementById('createButton');
        const updateButton = document.getElementById('updateButton');
        const formTitle = document.getElementById('formTitle');

        if (btnShowForm) {
            btnShowForm.addEventListener('click', () => {
                resetForm();
                if (formTitle) formTitle.textContent = 'Agregar Detalle de Usuario';
                if (createButton) createButton.style.display = 'inline-block';
                if (updateButton) updateButton.style.display = 'none';
                if (formContainer) formContainer.style.display = 'block';
                btnShowForm.style.display = 'none';
            });
        }

        function hideForm() {
            if (formContainer) formContainer.style.display = 'none';
            if (btnShowForm) btnShowForm.style.display = 'inline-block';
            if (createButton) createButton.style.display = 'none';
            if (updateButton) updateButton.style.display = 'none';
        }

        function resetForm() {
            const form = document.getElementById('detailUserForm');
            if (form) form.reset();
            const idInput = document.querySelector('[name="DetailUser.Id"]');
            if (idInput) idInput.value = '0';
            const activeCheckbox = document.querySelector('[name="DetailUser.IsActive"]');
            if (activeCheckbox) activeCheckbox.checked = true;
        }

        // Llenar formulario para editar
        function fillEditForm(id, userId, membershipId, startDate, endDate, sessionsLeft, isActive) {
            resetForm();

            const setIf = (selector, value) => {
                const el = document.querySelector(selector);
                if (el) el.value = value ?? '';
            };

            setIf('[name="DetailUser.Id"]', id);
            setIf('[name="DetailUser.IdUser"]', userId);
            setIf('[name="DetailUser.IdMembership"]', membershipId);
            setIf('[name="DetailUser.StartDate"]', startDate);
            setIf('[name="DetailUser.EndDate"]', endDate);
            setIf('[name="DetailUser.SessionsLeft"]', sessionsLeft);

            const activeEl = document.querySelector('[name="DetailUser.IsActive"]');
            if (activeEl) activeEl.checked = (String(isActive) === 'true');

            if (formTitle) formTitle.textContent = 'Editar Detalle de Usuario';
            if (createButton) createButton.style.display = 'none';
            if (updateButton) updateButton.style.display = 'inline-block';
            if (formContainer) formContainer.style.display = 'block';
            if (btnShowForm) btnShowForm.style.display = 'none';

            if (formContainer) formContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Validación de fechas en tiempo real (si los inputs existen)
        document.addEventListener('DOMContentLoaded', function () {
            const startDateInput = document.querySelector('[name="DetailUser.StartDate"]');
            const endDateInput = document.querySelector('[name="DetailUser.EndDate"]');

            if (!startDateInput || !endDateInput) return;

            function validateDates() {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);

                if (startDate && endDate && endDate <= startDate) {
                    endDateInput.setCustomValidity('La fecha de fin debe ser posterior a la fecha de inicio.');
                } else {
                    endDateInput.setCustomValidity('');
                }
            }

            startDateInput.addEventListener('change', validateDates);
            endDateInput.addEventListener('change', validateDates);
        });
    </script>
}
