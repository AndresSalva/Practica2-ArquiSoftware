@page
@model GYMPT.Pages.Reports.IndexModel
@{
    ViewData["Title"] = "Generar Reportes";
}

<div class="container mt-4">
    <h2>@ViewData["Title"]</h2>

    <form method="post" asp-page-handler="GenerateReport">
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="reportType" class="form-label">Tipo de Reporte</label>
                    <select class="form-select" id="reportType" name="ReportType" required>
                        <option value="">Seleccione un reporte</option>
                        <option value="instructorPerformance">Rendimiento de Instructores</option>
                        <option value="clientMembership">Clientes y Membresías</option>
                        <option value="disciplineSchedule">Horario de Disciplinas</option>
                    </select>
                </div>
            </div>

            <div class="col-md-4">
                <div class="mb-3">
                    <label for="format" class="form-label">Formato</label>
                    <select class="form-select" id="format" name="Format" required>
                        <option value="pdf">Documento PDF</option>
                        <option value="excel">Documento Excel</option>
                    </select>
                </div>
            </div>

            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-eye"></i> Generar y Ver Reporte
                        </button>
                    </div>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger mt-3" role="alert">
                @Model.ErrorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <div class="alert alert-success mt-3" role="alert">
                @Model.SuccessMessage
            </div>
        }
    </form>

    <!-- Sección de Preview del PDF -->
    @if (Model.ShowPreview && Model.GeneratedReport != null)
    {
        <div class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Vista Previa del Reporte</h4>
                <div>
                    <a href="@Url.Page("", "DownloadReport")" class="btn btn-success">
                        <i class="fas fa-download"></i> Descargar PDF
                    </a>
                    <button type="button" class="btn btn-secondary" onclick="window.print()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                </div>
            </div>

            <div class="border rounded">
                <iframe src="data:application/pdf;base64,@Model.GetReportBase64()" width="100%" height="600px"
                    frameborder="0" class="w-100">
                    <p>Tu navegador no soporta la visualización de PDFs.
                        <a href="@Url.Page("", "DownloadReport")">Descarga el PDF</a>.
                    </p>
                </iframe>
            </div>

            <!-- Fallback para navegadores que no soportan embed -->
            <div class="alert alert-info mt-3">
                <small>
                    Si no puedes ver el PDF,
                    <a href="@Url.Page("", "DownloadReport")" class="alert-link">haz clic aquí para descargarlo</a>.
                </small>
            </div>
        </div>
    }
</div>

<style>
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }

    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }

    .form-label {
        font-weight: 500;
    }

    /* Mejorar la visualización del PDF */
    embed {
        min-height: 600px;
        border: none;
    }
</style>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.querySelector('form');
            const submitBtn = form.querySelector('button[type="submit"]');

            form.addEventListener('submit', function () {
                // Mostrar loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
            });

            // Validación básica
            document.getElementById('reportType').addEventListener('change', validateForm);
            document.getElementById('format').addEventListener('change', validateForm);

            function validateForm() {
                const reportType = document.getElementById('reportType').value;
                const format = document.getElementById('format').value;
                submitBtn.disabled = !reportType || !format;
            }

            validateForm();
        });

        // Scroll automático al preview cuando se genera
        @if (Model.ShowPreview)
            {
                <text>
                    document.addEventListener('DOMContentLoaded', function() {
                        document.querySelector('.mt-4').scrollIntoView({
                            behavior: 'smooth'
                        });
                            });
                </text>
        }
    </script>
}